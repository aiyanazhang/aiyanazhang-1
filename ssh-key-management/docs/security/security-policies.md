# SSHå®‰å…¨ç­–ç•¥

## æ¦‚è¿°

SSHå®‰å…¨ç­–ç•¥æ˜¯ä¿æŠ¤SSHç¯å¢ƒçš„æ ¸å¿ƒæ¡†æ¶ï¼ŒåŒ…æ‹¬å¯†é’¥ç®¡ç†ã€è®¿é—®æ§åˆ¶ã€ç›‘æ§å®¡è®¡ç­‰å¤šä¸ªæ–¹é¢ã€‚å®Œå–„çš„å®‰å…¨ç­–ç•¥å¯ä»¥æœ‰æ•ˆé˜²èŒƒå¨èƒã€é™ä½é£é™©å¹¶ç¡®ä¿åˆè§„æ€§ã€‚

## å®‰å…¨æ¡†æ¶è®¾è®¡

### å¤šå±‚é˜²æŠ¤æ¨¡å‹

```mermaid
graph TB
    A[SSHå®‰å…¨é˜²æŠ¤å±‚æ¬¡] --> B[ç½‘ç»œå±‚é˜²æŠ¤]
    A --> C[ä¸»æœºå±‚é˜²æŠ¤]
    A --> D[åº”ç”¨å±‚é˜²æŠ¤]
    A --> E[æ•°æ®å±‚é˜²æŠ¤]
    
    B --> B1[é˜²ç«å¢™è§„åˆ™]
    B --> B2[VPNéš§é“]
    
    C --> C1[ç³»ç»ŸåŠ å›º]
    C --> C2[å…¥ä¾µæ£€æµ‹]
    
    D --> D1[SSHé…ç½®å¼ºåŒ–]
    D --> D2[å¯†é’¥ç®¡ç†]
    
    E --> E1[ä¼ è¾“åŠ å¯†]
    E --> E2[å®¡è®¡æ—¥å¿—]
    
    style B fill:#ffebee
    style C fill:#e8f5e8
    style D fill:#e3f2fd
    style E fill:#fff3e0
```

### é£é™©è¯„ä¼°çŸ©é˜µ

| å¨èƒç±»å‹ | å½±å“ç¨‹åº¦ | å‘ç”Ÿæ¦‚ç‡ | é£é™©ç­‰çº§ | é˜²æŠ¤æªæ–½ |
|----------|----------|----------|----------|----------|
| æš´åŠ›ç ´è§£ | ä¸­ | é«˜ | é«˜ | å¯†é’¥è®¤è¯ã€å¤±è´¥å»¶è¿Ÿ |
| ä¸­é—´äººæ”»å‡» | é«˜ | ä¸­ | é«˜ | ä¸»æœºå¯†é’¥éªŒè¯ã€CAä½“ç³» |
| å†…éƒ¨å¨èƒ | é«˜ | ä½ | ä¸­ | æœ€å°æƒé™ã€å®¡è®¡ç›‘æ§ |
| é…ç½®é”™è¯¯ | ä¸­ | ä¸­ | ä¸­ | é…ç½®ç®¡ç†ã€å®šæœŸå®¡è®¡ |
| å¯†é’¥æ³„éœ² | é«˜ | ä½ | ä¸­ | å¯†é’¥è½®æ¢ã€è®¿é—®æ§åˆ¶ |

## å¯†é’¥å®‰å…¨ç­–ç•¥

### å¯†é’¥å®‰å…¨ç­‰çº§åˆ†ç±»

```bash
# å¯†é’¥å®‰å…¨ç­‰çº§å®šä¹‰

# 1çº§ - åŸºç¡€å®‰å…¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
LEVEL1_KEY_TYPE="rsa"
LEVEL1_KEY_LENGTH="2048"
LEVEL1_ROTATION_PERIOD="365 days"

# 2çº§ - æ ‡å‡†å®‰å…¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
LEVEL2_KEY_TYPE="ecdsa"
LEVEL2_KEY_LENGTH="384"
LEVEL2_ROTATION_PERIOD="180 days"

# 3çº§ - é«˜åº¦å®‰å…¨ï¼ˆå…³é”®ç³»ç»Ÿï¼‰
LEVEL3_KEY_TYPE="ed25519"
LEVEL3_ROTATION_PERIOD="90 days"
LEVEL3_PASSPHRASE="required"
```

### å¯†é’¥è½®æ¢è‡ªåŠ¨åŒ–

```bash
#!/bin/bash
# å¯†é’¥è½®æ¢ç­–ç•¥è„šæœ¬

# å®‰å…¨ç­‰çº§é…ç½®
declare -A SECURITY_LEVELS=(
    ["development"]="90:ecdsa:256"
    ["production"]="30:ed25519:256"
    ["critical"]="15:ed25519:256"
)

# æ£€æŸ¥å¯†é’¥æ˜¯å¦éœ€è¦è½®æ¢
needs_rotation() {
    local key_file="$1"
    local rotation_period="$2"
    
    if [[ ! -f "$key_file" ]]; then
        return 0  # å¯†é’¥ä¸å­˜åœ¨ï¼Œéœ€è¦ç”Ÿæˆ
    fi
    
    local key_age=$(( $(date +%s) - $(stat -c %Y "$key_file") ))
    local rotation_seconds=$(( rotation_period * 24 * 3600 ))
    
    [[ $key_age -gt $rotation_seconds ]]
}

# ç”Ÿæˆå®‰å…¨å¯†é’¥
generate_secure_key() {
    local key_name="$1"
    local key_type="$2"
    local output_dir="$3"
    
    case "$key_type" in
        "ed25519")
            ssh-keygen -t ed25519 -f "$output_dir/$key_name" -N "" -C "$key_name-$(date -Iseconds)"
            ;;
        "ecdsa")
            ssh-keygen -t ecdsa -b 384 -f "$output_dir/$key_name" -N "" -C "$key_name-$(date -Iseconds)"
            ;;
    esac
    
    echo "å®‰å…¨å¯†é’¥ç”Ÿæˆå®Œæˆ: $output_dir/$key_name"
}

# ä¸»è½®æ¢æµç¨‹
rotate_keys_by_policy() {
    local environment="$1"
    local config="${SECURITY_LEVELS[$environment]}"
    
    IFS=':' read -r rotation_days key_type key_length <<< "$config"
    
    echo "å¼€å§‹ $environment ç¯å¢ƒå¯†é’¥è½®æ¢ (è½®æ¢å‘¨æœŸ: $rotation_days å¤©)"
    
    # å®æ–½å¯†é’¥è½®æ¢é€»è¾‘
    # ...
}
```

## è®¿é—®æ§åˆ¶ç­–ç•¥

### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)

```yaml
# ssh-rbac-policy.yaml
roles:
  admin:
    description: "ç³»ç»Ÿç®¡ç†å‘˜"
    permissions:
      - ssh_access: all_hosts
      - port_forwarding: yes
      - shell_access: unrestricted
    constraints:
      - source_networks: ["admin_network"]
      - session_timeout: 3600
      
  developer:
    description: "å¼€å‘äººå‘˜"
    permissions:
      - ssh_access: ["dev_servers", "staging_servers"]
      - port_forwarding: local_only
      - shell_access: restricted
    constraints:
      - source_networks: ["office_network"]
      - session_timeout: 7200
      
  deploy:
    description: "éƒ¨ç½²è´¦æˆ·"
    permissions:
      - ssh_access: ["production_servers"]
      - port_forwarding: no
      - shell_access: command_only
    constraints:
      - force_command: "/usr/local/bin/deploy.sh"
      - session_timeout: 1800

users:
  john.doe:
    roles: ["admin"]
    ssh_keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... john.doe@company.com"
    additional_constraints:
      - mfa_required: yes
      
  deploy-bot:
    roles: ["deploy"]
    ssh_keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5... deploy-bot@automation"
    additional_constraints:
      - automated_only: yes
```

### è®¿é—®æ§åˆ¶å®æ–½

```bash
#!/bin/bash
# SSHè®¿é—®æ§åˆ¶ç­–ç•¥å®æ–½è„šæœ¬

AUTHORIZED_KEYS_DIR="/etc/ssh/authorized_keys"

# ç”Ÿæˆç”¨æˆ·çš„authorized_keysæ–‡ä»¶
generate_user_authorized_keys() {
    local username="$1"
    local user_roles="$2"
    local ssh_keys="$3"
    
    local authorized_keys_file="$AUTHORIZED_KEYS_DIR/$username"
    
    echo "# Generated by SSH RBAC Policy - $(date)" > "$authorized_keys_file"
    
    # æ ¹æ®è§’è‰²æ·»åŠ é™åˆ¶é€‰é¡¹
    local key_options=""
    case "$user_roles" in
        *admin*)
            key_options="no-user-rc"
            ;;
        *developer*)
            key_options="no-port-forwarding,no-X11-forwarding,no-user-rc"
            ;;
        *deploy*)
            key_options="command=\"/usr/local/bin/deploy.sh\",no-port-forwarding,no-X11-forwarding,no-pty"
            ;;
    esac
    
    # å†™å…¥å¯†é’¥
    while IFS= read -r key; do
        [[ -z "$key" ]] && continue
        echo "$key_options $key" >> "$authorized_keys_file"
    done <<< "$ssh_keys"
    
    chmod 600 "$authorized_keys_file"
}

# æ›´æ–°sshd_config
update_sshd_config() {
    local sshd_config="/etc/ssh/sshd_config"
    
    # ä½¿ç”¨é›†ä¸­åŒ–authorized_keys
    sed -i 's|^#\?AuthorizedKeysFile.*|AuthorizedKeysFile /etc/ssh/authorized_keys/%u|' "$sshd_config"
    
    # æ·»åŠ è§’è‰²åŒ¹é…è§„åˆ™
    cat >> "$sshd_config" << 'EOF'

# RBAC Policy Enforcement
Match Group admin
    AllowTcpForwarding yes
    X11Forwarding yes

Match Group developer  
    AllowTcpForwarding local
    X11Forwarding yes

Match Group deploy
    AllowTcpForwarding no
    X11Forwarding no
    ForceCommand /usr/local/bin/deploy.sh
EOF

    systemctl reload sshd
}
```

## ç½‘ç»œå®‰å…¨ç­–ç•¥

### é˜²ç«å¢™è§„åˆ™

```bash
#!/bin/bash
# SSHé˜²ç«å¢™è§„åˆ™é…ç½®

# è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# å…è®¸æœ¬åœ°å›ç¯
iptables -A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSHè®¿é—®è§„åˆ™
iptables -A INPUT -p tcp -s 192.168.1.0/24 --dport 22 -j ACCEPT
iptables -A INPUT -p tcp -s 10.0.1.0/24 --dport 22 -j ACCEPT

# é™åˆ¶SSHè¿æ¥é¢‘ç‡ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 --name SSH -j DROP

# è®°å½•è¢«æ‹’ç»çš„è¿æ¥
iptables -A INPUT -p tcp --dport 22 -j LOG --log-prefix "SSH-DENIED: "
iptables -A INPUT -p tcp --dport 22 -j DROP

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4
```

### å…¥ä¾µæ£€æµ‹

```bash
#!/bin/bash
# SSHå…¥ä¾µæ£€æµ‹é…ç½®

# Fail2bané…ç½®
configure_fail2ban() {
    cat > /etc/fail2ban/jail.d/ssh-custom.conf << 'EOF'
[sshd]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600

[sshd-ddos]
enabled = true
port = 22
filter = sshd-ddos
logpath = /var/log/auth.log
maxretry = 10
bantime = 600
findtime = 60
EOF

    systemctl restart fail2ban
}

# å®æ—¶ç›‘æ§
create_ssh_monitor() {
    cat > /usr/local/bin/ssh-monitor.sh << 'EOF'
#!/bin/bash
ALERT_EMAIL="admin@company.com"
LOG_FILE="/var/log/auth.log"

# ç›‘æ§å¤±è´¥ç™»å½•
failed_logins=$(grep "$(date '+%b %d')" "$LOG_FILE" | \
               grep "authentication failure" | wc -l)

if [[ $failed_logins -gt 50 ]]; then
    echo "è­¦å‘Š: ä»Šæ—¥å¤±è´¥ç™»å½•æ¬¡æ•°å¼‚å¸¸ ($failed_logins æ¬¡)" | \
    mail -s "SSHå®‰å…¨è­¦æŠ¥" "$ALERT_EMAIL"
fi

# æ£€æŸ¥å¼‚å¸¸IP
grep "$(date '+%b %d')" "$LOG_FILE" | \
grep "Accepted publickey" | \
awk '{print $11}' | sort | uniq -c | \
awk '$1 > 100 {print "é«˜é¢‘ç™»å½•IP: " $2 " (" $1 " æ¬¡)"}' | \
mail -s "SSHå¼‚å¸¸æ´»åŠ¨æ£€æµ‹" "$ALERT_EMAIL"
EOF

    chmod +x /usr/local/bin/ssh-monitor.sh
    echo "*/10 * * * * /usr/local/bin/ssh-monitor.sh" | crontab -
}

configure_fail2ban
create_ssh_monitor
```

## å®¡è®¡å’Œåˆè§„

### å®¡è®¡ç­–ç•¥

```bash
#!/bin/bash
# SSHå®¡è®¡é…ç½®

# é…ç½®SSHæ—¥å¿—
configure_ssh_logging() {
    cat > /etc/rsyslog.d/50-ssh-audit.conf << 'EOF'
auth.info /var/log/ssh-audit/ssh-auth.log
authpriv.info /var/log/ssh-audit/ssh-auth.log
EOF

    systemctl restart rsyslog
}

# ä¼šè¯è®°å½•
create_session_logger() {
    cat > /usr/local/bin/ssh-session-logger.sh << 'EOF'
#!/bin/bash
SESSION_LOG_DIR="/var/log/ssh-sessions"
SESSION_ID="${SSH_CLIENT// /_}_$(date +%Y%m%d_%H%M%S)_$$"
SESSION_LOG="$SESSION_LOG_DIR/${USER}_${SESSION_ID}.log"

mkdir -p "$SESSION_LOG_DIR"

{
    echo "=== SSHä¼šè¯å¼€å§‹ ==="
    echo "æ—¶é—´: $(date)"
    echo "ç”¨æˆ·: $USER"
    echo "å®¢æˆ·ç«¯: $SSH_CLIENT"
    echo "==================="
} >> "$SESSION_LOG"

if [[ -z "$SSH_ORIGINAL_COMMAND" ]]; then
    script -q -a -f "$SESSION_LOG"
else
    echo "æ‰§è¡Œå‘½ä»¤: $SSH_ORIGINAL_COMMAND" >> "$SESSION_LOG"
    eval "$SSH_ORIGINAL_COMMAND"
fi
EOF

    chmod +x /usr/local/bin/ssh-session-logger.sh
}

configure_ssh_logging
create_session_logger
```

### åˆè§„æ€§æŠ¥å‘Š

```bash
#!/bin/bash
# ç”ŸæˆSSHåˆè§„æ€§æŠ¥å‘Š

generate_compliance_report() {
    local report_file="/var/reports/ssh-compliance-$(date +%Y%m%d).txt"
    mkdir -p /var/reports
    
    {
        echo "SSHå®‰å…¨åˆè§„æ€§æŠ¥å‘Š - $(date)"
        echo "=============================="
        
        echo "1. é…ç½®åˆè§„æ€§æ£€æŸ¥"
        if sshd -T | grep -q "protocol 2"; then
            echo "âœ… åè®®ç‰ˆæœ¬: SSH-2"
        else
            echo "âŒ åè®®ç‰ˆæœ¬: ä¸ç¬¦åˆè¦æ±‚"
        fi
        
        local root_login=$(sshd -T | grep permitrootlogin | awk '{print $2}')
        if [[ "$root_login" == "no" ]]; then
            echo "âœ… Rootç™»å½•: å·²ç¦ç”¨"
        else
            echo "âŒ Rootç™»å½•: æœªç¦ç”¨"
        fi
        
        echo ""
        echo "2. å¯†é’¥ç®¡ç†æ£€æŸ¥"
        local weak_keys=0
        for key_file in /etc/ssh/ssh_host_*_key.pub; do
            [[ ! -f "$key_file" ]] && continue
            
            local key_info=$(ssh-keygen -l -f "$key_file")
            local key_type=$(echo "$key_info" | awk '{print $4}')
            
            if [[ "$key_type" == "(DSA)" ]]; then
                echo "âŒ å‘ç°DSAå¯†é’¥ï¼ˆå·²è¿‡æ—¶ï¼‰"
                ((weak_keys++))
            fi
        done
        
        if [[ $weak_keys -eq 0 ]]; then
            echo "âœ… ä¸»æœºå¯†é’¥ç¬¦åˆè¦æ±‚"
        fi
        
        echo ""
        echo "3. å®¡è®¡æ—¥å¿—çŠ¶æ€"
        if [[ -d "/var/log/ssh-audit" ]]; then
            echo "âœ… å®¡è®¡æ—¥å¿—å·²é…ç½®"
        else
            echo "âŒ å®¡è®¡æ—¥å¿—æœªé…ç½®"
        fi
        
    } > "$report_file"
    
    echo "åˆè§„æ€§æŠ¥å‘Šç”Ÿæˆ: $report_file"
}

generate_compliance_report
```

## æœ€ä½³å®è·µæ€»ç»“

### å®‰å…¨ç­–ç•¥æ£€æŸ¥æ¸…å•

#### âœ… å¯†é’¥ç®¡ç†
- [ ] å®æ–½å¯†é’¥åˆ†çº§ç®¡ç†
- [ ] å»ºç«‹å¯†é’¥è½®æ¢æœºåˆ¶
- [ ] ä½¿ç”¨å¼ºå¯†ç çŸ­è¯­ä¿æŠ¤
- [ ] å®šæœŸå®¡è®¡å¯†é’¥ä½¿ç”¨

#### âœ… è®¿é—®æ§åˆ¶
- [ ] å®æ–½åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- [ ] é…ç½®æœ€å°æƒé™åŸåˆ™
- [ ] é™åˆ¶ç½‘ç»œè®¿é—®æ¥æº
- [ ] ç›‘æ§å¼‚å¸¸è®¿é—®æ´»åŠ¨

#### âœ… ç½‘ç»œå®‰å…¨
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] å®æ–½å…¥ä¾µæ£€æµ‹
- [ ] å¯ç”¨è¿æ¥é™åˆ¶
- [ ] è®°å½•å®‰å…¨äº‹ä»¶

#### âœ… å®¡è®¡åˆè§„
- [ ] é…ç½®å®¡è®¡æ—¥å¿—
- [ ] å®æ–½ä¼šè¯è®°å½•
- [ ] å®šæœŸç”Ÿæˆåˆè§„æŠ¥å‘Š
- [ ] ä¿æŒæ—¥å¿—å®Œæ•´æ€§

## ä¸‹ä¸€æ­¥

å®Œæˆå®‰å…¨ç­–ç•¥åï¼Œå»ºè®®ç»§ç»­ï¼š

1. **[æ•…éšœæ’é™¤](../troubleshooting/diagnostic-guide.md)** - è§£å†³å¸¸è§é—®é¢˜
2. **[é«˜çº§åº”ç”¨](../advanced/certificate-auth.md)** - æ¢ç´¢é«˜çº§åŠŸèƒ½
3. **[ç›‘æ§å®¡è®¡](./audit-logging.md)** - æ·±å…¥äº†è§£å®¡è®¡æœºåˆ¶

---

ğŸ”’ **å®‰å…¨æé†’**: 
- å®šæœŸå®¡æŸ¥å’Œæ›´æ–°å®‰å…¨ç­–ç•¥
- ä¿æŒå®‰å…¨é…ç½®çš„ä¸€è‡´æ€§
- åŠæ—¶å“åº”å®‰å…¨äº‹ä»¶
- æŒç»­æ”¹è¿›å®‰å…¨æªæ–½