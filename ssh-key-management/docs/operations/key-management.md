# SSHå¯†é’¥ç®¡ç†ç­–ç•¥

## æ¦‚è¿°

SSHå¯†é’¥ç®¡ç†æ˜¯ç»´æŠ¤å®‰å…¨SSHç¯å¢ƒçš„æ ¸å¿ƒï¼Œæ¶µç›–å¯†é’¥çš„åˆ›å»ºã€åˆ†å‘ã€ç›‘æ§ã€è½®æ¢å’Œæ’¤é”€ç­‰å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚æœ‰æ•ˆçš„å¯†é’¥ç®¡ç†ç­–ç•¥å¯ä»¥å¤§å¤§é™ä½å®‰å…¨é£é™©å¹¶æé«˜è¿ç»´æ•ˆç‡ã€‚

## å¯†é’¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

### ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ

```mermaid
stateDiagram-v2
    [*] --> è§„åˆ’é˜¶æ®µ
    è§„åˆ’é˜¶æ®µ --> ç”Ÿæˆé˜¶æ®µ: éœ€æ±‚ç¡®è®¤
    ç”Ÿæˆé˜¶æ®µ --> åˆ†å‘é˜¶æ®µ: å¯†é’¥ç”Ÿæˆå®Œæˆ
    åˆ†å‘é˜¶æ®µ --> æ¿€æ´»é˜¶æ®µ: éƒ¨ç½²å®Œæˆ
    æ¿€æ´»é˜¶æ®µ --> ä½¿ç”¨é˜¶æ®µ: éªŒè¯é€šè¿‡
    ä½¿ç”¨é˜¶æ®µ --> ç›‘æ§é˜¶æ®µ: æŠ•å…¥ä½¿ç”¨
    ç›‘æ§é˜¶æ®µ --> è½®æ¢é˜¶æ®µ: å‘¨æœŸåˆ°è¾¾
    è½®æ¢é˜¶æ®µ --> ç”Ÿæˆé˜¶æ®µ: ç”Ÿæˆæ–°å¯†é’¥
    ç›‘æ§é˜¶æ®µ --> æ’¤é”€é˜¶æ®µ: å‘ç°é£é™©
    æ’¤é”€é˜¶æ®µ --> é”€æ¯é˜¶æ®µ: æ’¤é”€å®Œæˆ
    é”€æ¯é˜¶æ®µ --> [*]
```

### å„é˜¶æ®µç®¡ç†è¦ç‚¹

| é˜¶æ®µ | ä¸»è¦ä»»åŠ¡ | å…³é”®æŒ‡æ ‡ | è´Ÿè´£è§’è‰² |
|------|----------|----------|----------|
| **è§„åˆ’** | éœ€æ±‚åˆ†æã€ç­–ç•¥åˆ¶å®š | éœ€æ±‚è¦†ç›–ç‡ | å®‰å…¨å›¢é˜Ÿ |
| **ç”Ÿæˆ** | å¯†é’¥åˆ›å»ºã€å¼ºåº¦éªŒè¯ | å¯†é’¥å¼ºåº¦ã€ç”Ÿæˆæ—¶é—´ | ç³»ç»Ÿç®¡ç†å‘˜ |
| **åˆ†å‘** | å®‰å…¨éƒ¨ç½²ã€æƒé™é…ç½® | éƒ¨ç½²æˆåŠŸç‡ | è¿ç»´å›¢é˜Ÿ |
| **ä½¿ç”¨** | æ—¥å¸¸æ“ä½œã€è®¿é—®æ§åˆ¶ | ä½¿ç”¨é¢‘ç‡ã€é”™è¯¯ç‡ | æœ€ç»ˆç”¨æˆ· |
| **ç›‘æ§** | æ´»åŠ¨ç›‘æ§ã€å¼‚å¸¸æ£€æµ‹ | ç›‘æ§è¦†ç›–ç‡ | å®‰å…¨è¿è¥ |
| **è½®æ¢** | å®šæœŸæ›´æ–°ã€å¹³æ»‘è¿‡æ¸¡ | è½®æ¢å‘¨æœŸã€æˆåŠŸç‡ | è¿ç»´å›¢é˜Ÿ |
| **æ’¤é”€** | ç´§æ€¥æ’¤é”€ã€è®¿é—®é˜»æ–­ | å“åº”æ—¶é—´ | å®‰å…¨å›¢é˜Ÿ |

## å¯†é’¥ç»„ç»‡ç»“æ„

### å‘½åè§„èŒƒç­–ç•¥

#### ä¸ªäººå¯†é’¥å‘½å

```bash
# æ ¼å¼ï¼šid_{type}_{purpose}_{environment}
~/.ssh/id_ed25519_personal_general
~/.ssh/id_ed25519_work_development
~/.ssh/id_ed25519_github_projects
~/.ssh/id_rsa_legacy_compatibility

# ä¼ä¸šç¯å¢ƒæ ¼å¼ï¼šid_{type}_{dept}_{role}_{env}
~/.ssh/id_ed25519_it_admin_prod
~/.ssh/id_ed25519_dev_deploy_staging
~/.ssh/id_ecdsa_security_audit_all
```

### ç›®å½•ç»„ç»‡ç»“æ„

```bash
# ç”¨æˆ·å¯†é’¥ç›®å½•ç»“æ„
~/.ssh/
â”œâ”€â”€ keys/
â”‚   â”œâ”€â”€ personal/
â”‚   â”‚   â”œâ”€â”€ id_ed25519_github
â”‚   â”‚   â”œâ”€â”€ id_ed25519_personal_servers
â”‚   â”‚   â””â”€â”€ id_rsa_legacy_systems
â”‚   â”œâ”€â”€ work/
â”‚   â”‚   â”œâ”€â”€ id_ed25519_company_prod
â”‚   â”‚   â”œâ”€â”€ id_ed25519_company_staging
â”‚   â”‚   â””â”€â”€ id_ecdsa_company_dev
â”‚   â””â”€â”€ archived/
â”‚       â”œâ”€â”€ old_id_rsa_2023
â”‚       â””â”€â”€ expired_id_ecdsa_2022
â”œâ”€â”€ config
â”œâ”€â”€ known_hosts
â””â”€â”€ authorized_keys
```

## å¯†é’¥è½®æ¢ç­–ç•¥

### è‡ªåŠ¨åŒ–è½®æ¢æµç¨‹

```mermaid
graph TD
    A[è½®æ¢è§¦å‘] --> B{è½®æ¢ç±»å‹}
    B -->|è®¡åˆ’è½®æ¢| C[æ£€æŸ¥è½®æ¢å‘¨æœŸ]
    B -->|ç´§æ€¥è½®æ¢| D[ç«‹å³å¼€å§‹è½®æ¢]
    
    C --> E[ç”Ÿæˆæ–°å¯†é’¥]
    D --> E
    
    E --> F[éƒ¨ç½²æ–°å¯†é’¥]
    F --> G[éªŒè¯æ–°å¯†é’¥]
    G --> H{éªŒè¯æˆåŠŸ?}
    
    H -->|æ˜¯| I[æ¿€æ´»æ–°å¯†é’¥]
    H -->|å¦| J[å›æ»šåˆ°æ—§å¯†é’¥]
    
    I --> K[å®½é™æœŸå¹¶è¡Œ]
    K --> L[æ’¤é”€æ—§å¯†é’¥]
    L --> M[æ¸…ç†æ—§å¯†é’¥]
    
    style E fill:#e8f5e8
    style I fill:#e8f5e8
    style L fill:#ffebee
```

### è½®æ¢å®æ–½è„šæœ¬

```bash
#!/bin/bash
# SSHå¯†é’¥è‡ªåŠ¨è½®æ¢è„šæœ¬

# ç”Ÿæˆæ–°å¯†é’¥
generate_new_key() {
    local key_name="$1"
    local key_type="$2"
    local output_dir="$3"
    
    echo "ç”Ÿæˆæ–°å¯†é’¥: $key_name ($key_type)"
    
    case "$key_type" in
        "ed25519")
            ssh-keygen -t ed25519 -f "$output_dir/$key_name" -N "" -C "rotated-$(date -Iseconds)"
            ;;
        "ecdsa")
            ssh-keygen -t ecdsa -b 384 -f "$output_dir/$key_name" -N "" -C "rotated-$(date -Iseconds)"
            ;;
        "rsa")
            ssh-keygen -t rsa -b 4096 -f "$output_dir/$key_name" -N "" -C "rotated-$(date -Iseconds)"
            ;;
    esac
}

# éƒ¨ç½²å¯†é’¥åˆ°æœåŠ¡å™¨
deploy_key_to_servers() {
    local key_file="$1"
    local servers_list="$2"
    local username="$3"
    
    while IFS= read -r server; do
        [[ -z "$server" || "$server" =~ ^# ]] && continue
        
        echo "éƒ¨ç½²å¯†é’¥åˆ°: $username@$server"
        ssh-copy-id -i "$key_file.pub" "$username@$server"
    done < "$servers_list"
}

# éªŒè¯æ–°å¯†é’¥
verify_new_key() {
    local key_file="$1"
    local servers_list="$2"
    local username="$3"
    
    while IFS= read -r server; do
        [[ -z "$server" || "$server" =~ ^# ]] && continue
        
        if ssh -i "$key_file" -o BatchMode=yes -o ConnectTimeout=10 \
           "$username@$server" 'echo "éªŒè¯æˆåŠŸ"' >/dev/null 2>&1; then
            echo "éªŒè¯æˆåŠŸ: $server"
        else
            echo "éªŒè¯å¤±è´¥: $server"
            return 1
        fi
    done < "$servers_list"
}
```

## è®¿é—®æ§åˆ¶å’Œå®¡è®¡

### åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

```mermaid
graph TB
    A[SSHè®¿é—®æ§åˆ¶] --> B[è§’è‰²å®šä¹‰]
    A --> C[æƒé™çŸ©é˜µ]
    A --> D[è®¿é—®ç­–ç•¥]
    
    B --> B1[ç®¡ç†å‘˜è§’è‰²]
    B --> B2[å¼€å‘è€…è§’è‰²]
    B --> B3[è¿ç»´è§’è‰²]
    B --> B4[å®¡è®¡è§’è‰²]
    
    C --> C1[æœåŠ¡å™¨è®¿é—®æƒé™]
    C --> C2[å‘½ä»¤æ‰§è¡Œæƒé™]
    C --> C3[æ–‡ä»¶è®¿é—®æƒé™]
    
    D --> D1[æ—¶é—´é™åˆ¶]
    D --> D2[IPé™åˆ¶]
    D --> D3[å‘½ä»¤é™åˆ¶]
    
    style B1 fill:#ff9999
    style B2 fill:#99ccff
    style B3 fill:#99ff99
    style B4 fill:#ffcc99
```

### å¯†é’¥ä½¿ç”¨ç›‘æ§

```bash
#!/bin/bash
# SSHå¯†é’¥ä½¿ç”¨ç›‘æ§è„šæœ¬

# åˆ†æSSHæ—¥å¿—
analyze_ssh_logs() {
    echo "=== SSHè®¿é—®ç»Ÿè®¡ ==="
    
    # ç»Ÿè®¡ä»Šæ—¥è¿æ¥
    grep "$(date '+%b %d')" /var/log/auth.log | \
    grep "Accepted publickey" | \
    awk '{print $9}' | sort | uniq -c | sort -nr
    
    echo "=== å¤±è´¥ç™»å½•å°è¯• ==="
    grep "$(date '+%b %d')" /var/log/auth.log | \
    grep "authentication failure" | \
    awk '{print $12}' | sort | uniq -c | sort -nr
}

# æ£€æŸ¥å¯†é’¥ä½¿ç”¨å¼‚å¸¸
check_anomalies() {
    echo "=== å¼‚å¸¸æ£€æµ‹ ==="
    
    # æ£€æŸ¥éå·¥ä½œæ—¶é—´è®¿é—®
    grep "$(date '+%b %d')" /var/log/auth.log | \
    grep "Accepted publickey" | \
    awk '$3 < 8 || $3 > 18 {print $0}' | \
    head -10
    
    # æ£€æŸ¥å¼‚å¸¸IP
    grep "$(date '+%b %d')" /var/log/auth.log | \
    grep "Accepted publickey" | \
    awk '{print $11}' | sort | uniq -c | \
    awk '$1 > 50 {print "é«˜é¢‘è®¿é—®IP: " $2 " (" $1 " æ¬¡)"}'
}

# ç”ŸæˆæŠ¥å‘Š
generate_report() {
    echo "SSHè®¿é—®å®¡è®¡æŠ¥å‘Š - $(date)"
    echo "================================"
    analyze_ssh_logs
    echo ""
    check_anomalies
}

generate_report
```

## æœ€ä½³å®è·µæ€»ç»“

### å¯†é’¥ç®¡ç†æ£€æŸ¥æ¸…å•

#### âœ… ç”Ÿæˆé˜¶æ®µ
- [ ] é€‰æ‹©åˆé€‚çš„å¯†é’¥ç±»å‹å’Œé•¿åº¦
- [ ] ä½¿ç”¨å¼ºå¯†ç çŸ­è¯­ä¿æŠ¤ç§é’¥
- [ ] è®¾ç½®æœ‰æ„ä¹‰çš„å¯†é’¥æ³¨é‡Š
- [ ] éªŒè¯å¯†é’¥æŒ‡çº¹

#### âœ… éƒ¨ç½²é˜¶æ®µ
- [ ] ä½¿ç”¨å®‰å…¨çš„éƒ¨ç½²æ–¹æ³•
- [ ] è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
- [ ] é…ç½®åˆé€‚çš„å¯†é’¥é€‰é¡¹
- [ ] æµ‹è¯•è¿æ¥åŠŸèƒ½

#### âœ… ä½¿ç”¨é˜¶æ®µ
- [ ] å®šæœŸç›‘æ§å¯†é’¥ä½¿ç”¨
- [ ] è®°å½•è®¿é—®æ—¥å¿—
- [ ] æ£€æµ‹å¼‚å¸¸æ´»åŠ¨
- [ ] ç»´æŠ¤å¯†é’¥æ¸…å•

#### âœ… ç»´æŠ¤é˜¶æ®µ
- [ ] å®šæœŸè½®æ¢å¯†é’¥
- [ ] æ¸…ç†è¿‡æœŸå¯†é’¥
- [ ] æ›´æ–°å¯†é’¥æ–‡æ¡£
- [ ] å¤‡ä»½é‡è¦å¯†é’¥

### å®‰å…¨åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**: åªæˆäºˆå¿…è¦çš„è®¿é—®æƒé™
2. **èŒè´£åˆ†ç¦»**: ä¸åŒè§’è‰²ä½¿ç”¨ä¸åŒå¯†é’¥
3. **å®šæœŸè½®æ¢**: å»ºç«‹å¯†é’¥è½®æ¢å‘¨æœŸ
4. **ç›‘æ§å®¡è®¡**: è®°å½•æ‰€æœ‰å¯†é’¥æ´»åŠ¨
5. **å¤‡ä»½æ¢å¤**: å»ºç«‹å¯†é’¥å¤‡ä»½æœºåˆ¶

## ä¸‹ä¸€æ­¥

å®Œæˆå¯†é’¥ç®¡ç†ç­–ç•¥åï¼Œå»ºè®®ç»§ç»­ï¼š

1. **[å®‰å…¨é…ç½®](../security/security-policies.md)** - å®æ–½å®‰å…¨ç­–ç•¥
2. **[æ•…éšœæ’é™¤](../troubleshooting/diagnostic-guide.md)** - å¤„ç†å¸¸è§é—®é¢˜
3. **[é«˜çº§åº”ç”¨](../advanced/certificate-auth.md)** - æ¢ç´¢é«˜çº§åŠŸèƒ½

---

ğŸ” **ç®¡ç†æé†’**: 
- å»ºç«‹å®Œå–„çš„å¯†é’¥ç®¡ç†æµç¨‹
- å®šæœŸå®¡æŸ¥å’Œæ›´æ–°ç®¡ç†ç­–ç•¥
- åŸ¹è®­å›¢é˜Ÿæˆå‘˜æŒæ¡æœ€ä½³å®è·µ
- æŒç»­æ”¹è¿›ç®¡ç†å·¥å…·å’Œæ–¹æ³•