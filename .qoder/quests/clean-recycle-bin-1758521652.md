# 回收站清理脚本系统设计

## 概述

设计一个安全可靠的Shell脚本系统，专门用于清理本机回收站内容。该系统将根据不同操作系统自动识别回收站位置，并提供多种清理选项，确保只删除回收站内容而不影响其他系统目录。

### 核心价值
- **安全性**：严格限制操作范围在回收站目录内，防止误删系统文件
- **跨平台支持**：自动识别不同操作系统的回收站位置
- **可控性**：提供多种清理模式，用户可选择清理范围和确认方式
- **可追溯性**：详细记录清理操作，支持操作审计

## 技术栈与依赖

| 组件 | 技术选型 | 说明 |
|------|----------|------|
| 脚本语言 | Bash Shell | 系统原生支持，兼容性好 |
| 配置管理 | JSON/INI文件 | 结构化配置存储 |
| 日志系统 | 文本日志 | 简单可靠的日志记录 |
| 用户交互 | 命令行界面 | 提供交互式和批处理模式 |
| 安全检查 | 路径白名单 | 严格的目录访问控制 |

## 系统架构

### 核心组件架构

```mermaid
graph TB
    A[主入口脚本] --> B[系统检测器]
    A --> C[配置管理器]
    A --> D[安全检查器]
    A --> E[回收站定位器]
    
    B --> F[操作系统识别]
    B --> G[权限检查]
    
    C --> H[参数解析]
    C --> I[配置加载]
    
    D --> J[路径验证]
    D --> K[权限验证]
    D --> L[安全边界检查]
    
    E --> M[macOS回收站]
    E --> N[Linux回收站]
    E --> O[Windows回收站]
    
    A --> P[清理执行器]
    P --> Q[文件扫描]
    P --> R[删除操作]
    P --> S[日志记录]
    
    style A fill:#e1f5fe
    style D fill:#fff3e0
    style P fill:#f3e5f5
```

### 数据流架构

```mermaid
flowchart LR
    A[用户输入] --> B[参数验证]
    B --> C{操作系统检测}
    
    C -->|macOS| D[~/.Trash]
    C -->|Linux| E[~/.local/share/Trash]
    C -->|Windows| F[C:/Recycle.Bin]
    
    D --> G[安全检查]
    E --> G
    F --> G
    
    G --> H{权限验证}
    H -->|通过| I[扫描回收站]
    H -->|失败| J[权限错误]
    
    I --> K[文件统计]
    K --> L{用户确认}
    L -->|确认| M[执行清理]
    L -->|取消| N[操作取消]
    
    M --> O[清理结果]
    O --> P[日志记录]
    
    style G fill:#ffeb3b
    style H fill:#ff9800
    style M fill:#4caf50
```

## 回收站路径映射

### 不同系统回收站位置表

| 操作系统 | 回收站路径 | 备注 |
|----------|------------|------|
| macOS | `~/.Trash/` | 用户级回收站 |
| macOS | `/Volumes/*/Trash/` | 外置存储设备回收站 |
| Linux (GNOME) | `~/.local/share/Trash/files/` | 标准XDG规范 |
| Linux (KDE) | `~/.local/share/Trash/files/` | 遵循同一规范 |
| Linux (通用) | `~/.trash/` | 部分发行版使用 |
| Windows | `C:\$Recycle.Bin\` | 系统级回收站 |
| Windows | `C:\RECYCLER\` | 旧版本Windows |

### 路径安全验证规则

| 验证类型 | 规则描述 | 实现方式 |
|----------|----------|----------|
| 路径白名单 | 仅允许操作预定义的回收站路径 | 硬编码路径列表匹配 |
| 路径深度检查 | 限制操作路径的目录深度 | 路径分割符计数验证 |
| 符号链接防护 | 防止通过软链接访问非回收站目录 | readlink检查真实路径 |
| 绝对路径验证 | 确保所有路径都是绝对路径 | 路径规范化处理 |
| 父目录检查 | 验证操作目录的父目录合法性 | 逐级目录验证 |

## 清理策略与模式

### 清理模式定义

```mermaid
graph LR
    A[清理模式] --> B[基础清理]
    A --> C[选择性清理]
    A --> D[深度清理]
    A --> E[预览模式]
    
    B --> B1[删除所有文件和文件夹]
    B --> B2[保留隐藏文件]
    
    C --> C1[按文件类型筛选]
    C --> C2[按时间范围筛选]
    C --> C3[按文件大小筛选]
    
    D --> D1[清理临时文件]
    D --> D2[清理元数据]
    D --> D3[压缩日志]
    
    E --> E1[仅显示统计]
    E --> E2[不执行删除]
    
    style B fill:#4caf50
    style C fill:#2196f3
    style D fill:#ff9800
    style E fill:#9e9e9e
```

### 筛选条件配置

| 筛选类型 | 配置参数 | 默认值 | 说明 |
|----------|----------|--------|------|
| 文件类型 | `--type` | `all` | 可选: files, dirs, all |
| 修改时间 | `--older-than` | 无限制 | 格式: 7d, 30d, 1m |
| 文件大小 | `--size-limit` | 无限制 | 格式: 100M, 1G |
| 文件名模式 | `--pattern` | `*` | 支持通配符匹配 |
| 深度限制 | `--max-depth` | 无限制 | 目录遍历深度 |

## 安全机制设计

### 多层安全检查流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant S as 脚本
    participant V as 验证器
    participant F as 文件系统

    U->>S: 执行清理命令
    S->>V: 路径安全检查
    V->>V: 白名单验证
    V->>V: 符号链接检查
    V->>V: 权限验证
    
    alt 安全检查通过
        V->>S: 验证成功
        S->>F: 扫描回收站
        F->>S: 返回文件列表
        S->>U: 显示清理预览
        U->>S: 确认执行
        S->>F: 执行删除操作
        F->>S: 返回操作结果
        S->>U: 显示清理结果
    else 安全检查失败
        V->>S: 验证失败
        S->>U: 显示安全错误
    end
```

### 权限管理策略

| 权限级别 | 访问范围 | 安全措施 |
|----------|----------|----------|
| 用户级 | 仅用户回收站 | 无需特殊权限 |
| 系统级 | 系统回收站 | 需要管理员权限 |
| 设备级 | 外置设备回收站 | 检查设备挂载状态 |

### 安全边界定义

```mermaid
graph TD
    A[安全边界] --> B[允许区域]
    A --> C[禁止区域]
    
    B --> B1[用户回收站目录]
    B --> B2[外置设备回收站]
    B --> B3[临时回收站缓存]
    
    C --> C1[系统根目录]
    C --> C2[用户家目录]
    C --> C3[系统配置目录]
    C --> C4[应用程序目录]
    
    style B fill:#c8e6c9
    style C fill:#ffcdd2
```

## 用户交互界面

### 命令行参数设计

| 参数 | 长格式 | 类型 | 默认值 | 说明 |
|------|--------|------|--------|------|
| `-h` | `--help` | 开关 | - | 显示帮助信息 |
| `-v` | `--verbose` | 开关 | false | 详细输出模式 |
| `-y` | `--yes` | 开关 | false | 自动确认，跳过交互 |
| `-n` | `--dry-run` | 开关 | false | 预览模式，不实际删除 |
| `-t` | `--type` | 字符串 | all | 清理类型(files/dirs/all) |
| `-d` | `--older-than` | 字符串 | - | 时间过滤条件 |
| `-s` | `--size-limit` | 字符串 | - | 大小过滤条件 |
| `-p` | `--pattern` | 字符串 | * | 文件名匹配模式 |
| `-c` | `--config` | 路径 | ~/.trash-cleaner.conf | 配置文件路径 |
| `-l` | `--log` | 路径 | ~/.trash-cleaner.log | 日志文件路径 |

### 交互流程设计

```mermaid
stateDiagram-v2
    [*] --> ParseArgs: 解析命令行参数
    ParseArgs --> ValidateConfig: 验证配置
    ValidateConfig --> DetectSystem: 检测操作系统
    
    DetectSystem --> ScanTrash: 扫描回收站
    ScanTrash --> ShowPreview: 显示清理预览
    
    ShowPreview --> ConfirmAction: 等待用户确认
    ConfirmAction --> ExecuteClean: 用户确认
    ConfirmAction --> CancelOperation: 用户取消
    
    ExecuteClean --> ShowResult: 显示清理结果
    CancelOperation --> LogOperation: 记录操作日志
    ShowResult --> LogOperation
    
    LogOperation --> [*]: 操作完成
```

### 输出格式设计

#### 预览模式输出示例

| 项目 | 数量 | 大小 | 最老文件时间 |
|------|------|------|-------------|
| 文件 | 127 | 2.3GB | 2024-01-15 |
| 文件夹 | 15 | - | 2024-02-01 |
| 总计 | 142 | 2.3GB | - |

#### 清理结果输出示例

| 状态 | 数量 | 大小 | 说明 |
|------|------|------|------|
| ✅ 成功删除 | 140 | 2.2GB | 正常清理 |
| ❌ 删除失败 | 2 | 100MB | 权限不足 |
| ⏭️ 跳过文件 | 0 | 0B | 无跳过文件 |

## 配置管理

### 配置文件结构

```mermaid
graph LR
    A[配置文件] --> B[基本设置]
    A --> C[安全策略]
    A --> D[清理规则]
    A --> E[日志配置]
    
    B --> B1[默认清理模式]
    B --> B2[确认策略]
    B --> B3[输出格式]
    
    C --> C1[路径白名单]
    C --> C2[权限要求]
    C --> C3[安全检查级别]
    
    D --> D1[文件类型规则]
    D --> D2[时间过滤规则]
    D --> D3[大小过滤规则]
    
    E --> E1[日志级别]
    E --> E2[日志文件路径]
    E --> E3[日志轮转策略]
```

### 配置参数表

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `default_mode` | 字符串 | "interactive" | 默认清理模式 |
| `confirm_deletion` | 布尔 | true | 是否需要确认删除 |
| `max_file_age_days` | 整数 | 0 | 文件最大保留天数(0=无限制) |
| `min_file_size_mb` | 整数 | 0 | 最小文件大小限制 |
| `enable_logging` | 布尔 | true | 是否启用日志记录 |
| `log_retention_days` | 整数 | 30 | 日志保留天数 |
| `color_output` | 布尔 | true | 是否使用彩色输出 |
| `progress_bar` | 布尔 | true | 是否显示进度条 |

## 日志与审计

### 日志记录策略

```mermaid
graph TD
    A[日志事件] --> B[操作日志]
    A --> C[安全日志]
    A --> D[错误日志]
    A --> E[性能日志]
    
    B --> B1[清理开始]
    B --> B2[文件扫描]
    B --> B3[删除操作]
    B --> B4[清理完成]
    
    C --> C1[权限检查]
    C --> C2[路径验证]
    C --> C3[安全违规]
    
    D --> D1[系统错误]
    D --> D2[权限错误]
    D --> D3[IO错误]
    
    E --> E1[扫描耗时]
    E --> E2[删除速度]
    E --> E3[内存使用]
    
    style B fill:#e8f5e8
    style C fill:#fff3cd
    style D fill:#f8d7da
    style E fill:#d1ecf1
```

### 日志格式定义

| 字段名 | 类型 | 示例值 | 说明 |
|--------|------|--------|------|
| timestamp | ISO8601 | 2024-12-20T10:30:00Z | 操作时间戳 |
| level | 字符串 | INFO/WARN/ERROR | 日志级别 |
| operation | 字符串 | SCAN/DELETE/VERIFY | 操作类型 |
| path | 字符串 | ~/.Trash/ | 操作路径 |
| count | 整数 | 125 | 文件数量 |
| size | 整数 | 2147483648 | 文件大小(字节) |
| duration | 浮点数 | 1.234 | 操作耗时(秒) |
| status | 字符串 | SUCCESS/FAILED | 操作状态 |
| message | 字符串 | Operation completed | 详细信息 |

## 错误处理与恢复

### 错误分类与处理

```mermaid
graph LR
    A[错误类型] --> B[系统错误]
    A --> C[权限错误]
    A --> D[路径错误]
    A --> E[IO错误]
    
    B --> B1[操作系统不支持]
    B --> B2[依赖命令缺失]
    B --> B3[系统资源不足]
    
    C --> C1[读取权限不足]
    C --> C2[删除权限不足]
    C --> C3[目录访问被拒绝]
    
    D --> D1[回收站路径不存在]
    D --> D2[路径格式错误]
    D --> D3[符号链接循环]
    
    E --> E1[磁盘空间不足]
    E --> E2[文件被占用]
    E --> E3[网络存储问题]
    
    style B fill:#ffebee
    style C fill:#fff3e0
    style D fill:#e8f5e8
    style E fill:#f3e5f5
```

### 异常恢复策略

| 错误类型 | 恢复策略 | 用户提示 |
|----------|----------|----------|
| 权限不足 | 提示使用sudo重试 | "需要管理员权限，请使用sudo执行" |
| 路径不存在 | 跳过该路径继续处理 | "回收站路径不存在，跳过处理" |
| 文件被占用 | 记录失败文件继续处理 | "部分文件正在使用中，无法删除" |
| 磁盘空间不足 | 停止操作并报告状态 | "磁盘空间不足，操作已停止" |
| 网络中断 | 重试机制，超时后失败 | "网络存储访问失败，请检查连接" |

## 性能优化

### 性能目标与指标

| 性能指标 | 目标值 | 测量方式 |
|----------|--------|----------|
| 文件扫描速度 | >1000文件/秒 | 单位时间处理文件数 |
| 内存使用 | <100MB | 运行时最大内存占用 |
| 启动时间 | <2秒 | 从执行到开始扫描的时间 |
| 大文件处理 | >1GB文件稳定删除 | 单个大文件删除成功率 |
| 并发安全 | 支持多实例运行 | 文件锁机制验证 |

### 优化策略设计

```mermaid
graph TD
    A[性能优化] --> B[扫描优化]
    A --> C[删除优化]
    A --> D[内存优化]
    A --> E[IO优化]
    
    B --> B1[并行目录遍历]
    B --> B2[智能跳过策略]
    B --> B3[缓存文件状态]
    
    C --> C1[批量删除操作]
    C --> C2[异步删除处理]
    C --> C3[进度反馈优化]
    
    D --> D1[流式处理大目录]
    D --> D2[及时释放资源]
    D --> D3[分块处理数据]
    
    E --> E1[顺序访问优化]
    E --> E2[减少系统调用]
    E --> E3[缓冲区优化]
    
    style B fill:#e3f2fd
    style C fill:#f3e5f5
    style D fill:#e8f5e8
    style E fill:#fff3e0
```

## 测试策略

### 测试层次架构

```mermaid
pyramid
    title 测试金字塔
    
    "手动测试" : 5
    "集成测试" : 15  
    "功能测试" : 30
    "单元测试" : 50
```

### 测试用例设计

| 测试类型 | 测试场景 | 预期结果 |
|----------|----------|----------|
| 功能测试 | 正常清理空回收站 | 操作成功，无文件删除 |
| 功能测试 | 清理包含文件的回收站 | 成功删除所有文件 |
| 功能测试 | 预览模式测试 | 显示统计信息，不删除文件 |
| 安全测试 | 尝试访问非回收站目录 | 被安全检查阻止 |
| 安全测试 | 符号链接攻击防护 | 识别并拒绝恶意链接 |
| 权限测试 | 无权限访问回收站 | 提示权限错误 |
| 权限测试 | 管理员权限测试 | 成功清理系统回收站 |
| 异常测试 | 磁盘空间不足 | 优雅处理并报告错误 |
| 异常测试 | 文件被占用 | 跳过占用文件继续处理 |
| 兼容测试 | macOS系统测试 | 正确识别并清理.Trash |
| 兼容测试 | Linux系统测试 | 正确识别并清理Trash目录 |
| 性能测试 | 大量文件清理 | 在规定时间内完成 |
| 性能测试 | 大文件删除 | 稳定删除GB级文件 |